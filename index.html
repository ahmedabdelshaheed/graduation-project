<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>AI Voice Project</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 50px; background: #f4f4f9; }
        #recordBtn { padding: 20px 40px; font-size: 20px; cursor: pointer; border-radius: 50px; border: none; background: #007bff; color: white; }
        #recordBtn.recording { background: #ff4d4d; }
        #result { margin-top: 30px; font-weight: bold; color: #333; }
    </style>
</head>
<body>

    <h1>ğŸ™ï¸ ØªÙƒÙ„Ù… Ù…Ø¹ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h1>
    
    <button id="recordBtn">Ø§Ø¶ØºØ· Ù„Ù„ØªØ­Ø¯Ø«</button>
    
    <div id="result">
        <p>Ù†Øµ Ø§Ù„ÙƒÙ„Ø§Ù… Ø§Ù„Ù…ØªØ±Ø¬Ù… Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§...</p>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        const recordBtn = document.getElementById('recordBtn');
        const resultDiv = document.getElementById('result');

        recordBtn.onclick = async () => {
            if (!mediaRecorder || mediaRecorder.state === "inactive") {
                // Ø¨Ø¯Ø¦ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    sendAudioToServer(audioBlob); // Ù†Ø±Ø³Ù„ Ø§Ù„ØµÙˆØª Ù„Ù„Ø³ÙŠØ±ÙØ±
                };

                mediaRecorder.start();
                recordBtn.innerText = "Ø¥ÙŠÙ‚Ø§Ù ÙˆØ¥Ø±Ø³Ø§Ù„";
                recordBtn.classList.add('recording');
            } else {
                // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                mediaRecorder.stop();
                recordBtn.innerText = "Ø§Ø¶ØºØ· Ù„Ù„ØªØ­Ø¯Ø«";
                recordBtn.classList.remove('recording');
            }
        };

        async function sendAudioToServer(blob) {
    resultDiv.innerHTML = "<p>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</p>";
    const formData = new FormData();
    formData.append('file', blob, 'audio.wav');

    try {
        // Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù„ÙŠ Ø·Ù„Ø¹Ù„Ùƒ Ù…Ù† ÙƒÙˆÙ„Ø§Ø¨ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆØ­Ø·Ù‡ Ù‡Ù†Ø§
        const response = await fetch('https://maritza-penetralian-extortionately.ngrok-free.dev/analyze', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) throw new Error('Server Error');

        const text = response.headers.get('X-Transcribed-Text');
        resultDiv.innerHTML = `<p>Ø£Ù†Øª Ù‚Ù„Øª: ${text || "Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ ØµÙˆØª"}</p>`;

        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);
        const audio = new Audio(audioUrl);
        audio.play();

    } catch (error) {
        console.error(error);
        resultDiv.innerHTML = "<p>Ø®Ø·Ø£: ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ø§Ù„ÙƒÙˆØ¯</p>";
    }
}
    </script>
</body>

</html>
